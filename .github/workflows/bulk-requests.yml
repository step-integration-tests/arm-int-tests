name: Generate Bulk Requests in Single Job

on:
  workflow_dispatch:

jobs:
  bulk-request:
    runs-on: ubuntu-latest
    steps:
        
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - uses: rohan-stepsecurity/harden-runner@91efb104a5d3c9a4d5d3db770717094acf011fb0 # int
        with:
         egress-policy: audit
         
      - name: Generate ~60 requests per domain+method combo
        run: |
          domains=("https://example1.com" "https://example2.com" "https://example3.com")
          methods=("GET" "POST" "PUT" "DELETE" "PATCH" )

          for domain in "${domains[@]}"; do
            for method in "${methods[@]}"; do
              echo "Sending ~60 requests to $domain using $method"

              for i in $(seq 1 60); do
                url="$domain/test-endpoint-$method-$i"
                echo "::group::[$domain][$method] Request #$i: $url"

                case "$method" in
                  GET)
                    curl -X GET "$url" -s -o /dev/null -w "Status: %{http_code}\n"
                    ;;
                  POST)
                    curl -X POST "$url" -H "Content-Type: application/json" \
                         -d "{\"index\": $i}" -s -o /dev/null -w "Status: %{http_code}\n"
                    ;;
                  PUT)
                    curl -X PUT "$url" -H "Content-Type: application/json" \
                         -d "{\"index\": $i}" -s -o /dev/null -w "Status: %{http_code}\n"
                    ;;
                  DELETE)
                    curl -X DELETE "$url" -s -o /dev/null -w "Status: %{http_code}\n"
                    ;;
                  PATCH)
                    curl -X PATCH "$url" -H "Content-Type: application/json" \
                         -d "{\"index\": $i}" -s -o /dev/null -w "Status: %{http_code}\n"
                    ;;
                  OPTIONS)
                    curl -X OPTIONS "$url" -s -o /dev/null -w "Status: %{http_code}\n"
                    ;;
                  HEAD)
                    curl -I "$url" -s -o /dev/null -w "Status: %{http_code}\n"
                    ;;
                esac

                echo "::endgroup::"
              done
              echo "---"
            done
          done
